<?xml version="1.0"?>
<!--
  Robotiq 2F-85 Gripper - Unified model compatible with both Isaac Sim and Gazebo
  
  This xacro uses the Isaac Sim kinematic structure with closed-loop kinematics.
  Joint hierarchy: outer_knuckle -> outer_finger -> inner_finger -> inner_knuckle
  
  Uses STL meshes converted from Isaac Sim export for compatibility across simulators.
-->
<robot xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Mesh directory -->
  <xacro:property name="mesh_dir" value="file://$(find tidybot_description)/meshes/grippers/robotiq_2f_85"/>

  <!-- ============================================ -->
  <!-- Link Definitions -->
  <!-- ============================================ -->

  <!-- Outer Knuckle Link -->
  <xacro:macro name="outer_knuckle" params="prefix fingerprefix reflect">
    <link name="${prefix}${fingerprefix}_outer_knuckle">
      <inertial>
        <origin xyz="${reflect * 0.0121152} ${reflect * -0.000638} 0." rpy="0. 0. 0."/>
        <mass value="0.0127346"/>
        <inertia ixx="0.0000003" ixy="0." ixz="0." iyy="0.0000021" iyz="0." izz="0.0000021"/>
      </inertial>
      <visual>
        <xacro:if value="${reflect > 0}">
          <origin xyz="-0.0306 -0.05466 0." rpy="${-pi} 0. ${pi}"/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.0306 0.05466 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_outer_knuckle.stl"/>
        </geometry>
        <material name="">
          <color rgba="0.792 0.820 0.933 1.0"/>
        </material>
      </visual>
      <collision>
        <xacro:if value="${reflect > 0}">
          <origin xyz="-0.0306 -0.05466 0." rpy="${-pi} 0. ${pi}"/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.0306 0.05466 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_outer_knuckle.stl"/>
        </geometry>
      </collision>
    </link>
    <gazebo reference="${prefix}${fingerprefix}_outer_knuckle">
      <material>Gazebo/Grey</material>
    </gazebo>
  </xacro:macro>

  <!-- Outer Finger Link -->
  <xacro:macro name="outer_finger" params="prefix fingerprefix reflect">
    <link name="${prefix}${fingerprefix}_outer_finger">
      <inertial>
        <origin xyz="${reflect * 0.0000055} ${reflect * -0.0659505} 0.0689531" rpy="0. 0. 0."/>
        <mass value="0.0391792"/>
        <inertia ixx="0.0000132" ixy="-0." ixz="-0." iyy="0.0000043" iyz="-0." izz="0.0000109"/>
      </inertial>
      <visual>
        <origin xyz="0. 0. 0." rpy="${pi/2} ${reflect * -0.0000001} ${reflect * pi/2}"/>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_outer_finger.stl"/>
        </geometry>
        <material name="">
          <color rgba="0.2 0.2 0.2 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0. 0. 0." rpy="${pi/2} ${reflect * -0.0000001} ${reflect * pi/2}"/>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_outer_finger.stl"/>
        </geometry>
      </collision>
    </link>
    <gazebo reference="${prefix}${fingerprefix}_outer_finger">
      <material>Gazebo/DarkGrey</material>
    </gazebo>
  </xacro:macro>

  <!-- Inner Finger Link (includes pad) -->
  <xacro:macro name="inner_finger" params="prefix fingerprefix reflect">
    <link name="${prefix}${fingerprefix}_inner_finger">
      <inertial>
        <origin xyz="0.0185829 ${reflect * -0.0274476} 0." rpy="0. 0. 0."/>
        <mass value="0.0197616"/>
        <inertia ixx="0.000001" ixy="0." ixz="-0." iyy="0.0000028" iyz="-0." izz="0.0000032"/>
      </inertial>
      <!-- Inner finger body -->
      <visual>
        <xacro:if value="${reflect > 0}">
          <origin xyz="0.06776 0.09809 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.06776 -0.09809 0." rpy="0. 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_inner_finger.stl"/>
        </geometry>
        <material name="">
          <color rgba="0.2 0.2 0.2 1.0"/>
        </material>
      </visual>
      <!-- Inner finger pad -->
      <visual>
        <xacro:if value="${reflect > 0}">
          <origin xyz="0.06776 0.09809 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.06776 -0.09809 0." rpy="0. 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_pad.stl"/>
        </geometry>
        <material name="">
          <color rgba="0.1 0.1 0.1 1.0"/>
        </material>
      </visual>
      <collision>
        <xacro:if value="${reflect > 0}">
          <origin xyz="0.06776 0.09809 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.06776 -0.09809 0." rpy="0. 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_inner_finger.stl"/>
        </geometry>
      </collision>
      <collision>
        <xacro:if value="${reflect > 0}">
          <origin xyz="0.06776 0.09809 0." rpy="${-pi} 0. 0."/>
        </xacro:if>
        <xacro:if value="${reflect &lt; 0}">
          <origin xyz="0.06776 -0.09809 0." rpy="0. 0. 0."/>
        </xacro:if>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_pad.stl"/>
        </geometry>
      </collision>
    </link>
    <gazebo reference="${prefix}${fingerprefix}_inner_finger">
      <material>Gazebo/DarkGrey</material>
    </gazebo>
  </xacro:macro>

  <!-- Inner Knuckle Link -->
  <xacro:macro name="inner_knuckle" params="prefix fingerprefix reflect">
    <link name="${prefix}${fingerprefix}_inner_knuckle">
      <inertial>
        <origin xyz="0.0176393 -0.0211796 0." rpy="0. 0. 0."/>
        <mass value="0.0273069"/>
        <inertia ixx="0.0000045" ixy="0." ixz="0." iyy="0.000008" iyz="-0." izz="0.0000118"/>
      </inertial>
      <visual>
        <origin xyz="0.04986 -0.1046 0." rpy="0. 0. 0."/>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_inner_knuckle.stl"/>
        </geometry>
        <material name="">
          <color rgba="0.2 0.2 0.2 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0.04986 -0.1046 0." rpy="0. 0. 0."/>
        <geometry>
          <mesh filename="${mesh_dir}/robotiq_arg2f_85_inner_knuckle.stl"/>
        </geometry>
      </collision>
    </link>
    <gazebo reference="${prefix}${fingerprefix}_inner_knuckle">
      <material>Gazebo/DarkGrey</material>
    </gazebo>
  </xacro:macro>

  <!-- ============================================ -->
  <!-- Joint Definitions -->
  <!-- ============================================ -->

  <!-- Left outer knuckle joint (leader joint - actuated) -->
  <xacro:macro name="left_outer_knuckle_joint" params="prefix">
    <joint name="${prefix}left_outer_knuckle_joint" type="revolute">
      <origin xyz="0. -0.0306 0.05466" rpy="${pi/2} 0. ${-pi/2}"/>
      <parent link="${prefix}robotiq_arg2f_base_link"/>
      <child link="${prefix}left_outer_knuckle"/>
      <axis xyz="0. 0. 1."/>
      <limit lower="0." upper="0.8203047" effort="26." velocity="2.5562093"/>
      <dynamics damping="1.0" friction="0.5"/>
    </joint>
    <xacro:finger_joints prefix="${prefix}" fingerprefix="left" reflect="1" mimic_mult="-1.0" knuckle_mimic_mult="-1.0"/>
  </xacro:macro>

  <!-- Right outer knuckle joint (mimic, same numeric value for symmetric motion) -->
  <xacro:macro name="right_outer_knuckle_joint" params="prefix">
    <joint name="${prefix}right_outer_knuckle_joint" type="revolute">
      <origin xyz="0. 0.0306 0.05466" rpy="${-pi/2} 0. ${-pi/2}"/>
      <parent link="${prefix}robotiq_arg2f_base_link"/>
      <child link="${prefix}right_outer_knuckle"/>
      <axis xyz="0. 0. 1."/>
      <limit lower="0." upper="0.8203047" effort="26." velocity="174.5329252"/>
      <mimic joint="${prefix}left_outer_knuckle_joint" multiplier="1.0" offset="0"/>
      <dynamics damping="1.0" friction="0.5"/>
    </joint>
    <xacro:finger_joints prefix="${prefix}" fingerprefix="right" reflect="-1" mimic_mult="1.0" knuckle_mimic_mult="-1.0"/>
  </xacro:macro>

  <!-- Outer finger joint (fixed to outer knuckle) -->
  <xacro:macro name="outer_finger_joint" params="prefix fingerprefix reflect">
    <joint name="${prefix}${fingerprefix}_outer_finger_joint" type="fixed">
      <xacro:if value="${reflect > 0}">
        <origin xyz="-0.0306 -0.05466 0." rpy="${-pi/2} ${pi/2} 0."/>
      </xacro:if>
      <xacro:if value="${reflect &lt; 0}">
        <origin xyz="0.0306 0.05466 0." rpy="${pi/2} ${-pi/2} 0."/>
      </xacro:if>
      <parent link="${prefix}${fingerprefix}_outer_knuckle"/>
      <child link="${prefix}${fingerprefix}_outer_finger"/>
    </joint>
  </xacro:macro>

  <!-- Inner finger joint (mimic) -->
  <xacro:macro name="inner_finger_joint" params="prefix fingerprefix reflect mimic_mult">
    <joint name="${prefix}${fingerprefix}_inner_finger_joint" type="revolute">
      <xacro:if value="${reflect > 0}">
        <origin xyz="0. -0.06776 0.09809" rpy="${-pi/2} 0. ${pi/2}"/>
      </xacro:if>
      <xacro:if value="${reflect &lt; 0}">
        <origin xyz="0. 0.06776 0.09809" rpy="${pi/2} 0. ${-pi/2}"/>
      </xacro:if>
      <parent link="${prefix}${fingerprefix}_outer_finger"/>
      <child link="${prefix}${fingerprefix}_inner_finger"/>
      <axis xyz="0. 0. 1."/>
      <limit lower="-3.1415927" upper="3.1415927" effort="26." velocity="174.5329252"/>
      <mimic joint="${prefix}left_outer_knuckle_joint" multiplier="${mimic_mult}" offset="0"/>
      <dynamics damping="1.0" friction="0.5"/>
    </joint>
  </xacro:macro>

  <!-- Inner knuckle joint (mimic, connects inner finger to inner knuckle) -->
  <xacro:macro name="inner_knuckle_joint" params="prefix fingerprefix reflect knuckle_mimic_mult">
    <joint name="${prefix}${fingerprefix}_inner_knuckle_joint" type="revolute">
      <xacro:if value="${reflect > 0}">
        <origin xyz="0.0179 -0.00651 0." rpy="${pi} 0. 0."/>
      </xacro:if>
      <xacro:if value="${reflect &lt; 0}">
        <origin xyz="0.0179 0.00651 0." rpy="0. 0. 0."/>
      </xacro:if>
      <parent link="${prefix}${fingerprefix}_inner_finger"/>
      <child link="${prefix}${fingerprefix}_inner_knuckle"/>
      <axis xyz="0. 0. 1."/>
      <limit lower="-3.1415927" upper="3.1415927" effort="26." velocity="174.5329252"/>
      <mimic joint="${prefix}left_outer_knuckle_joint" multiplier="${knuckle_mimic_mult}" offset="0"/>
      <dynamics damping="1.0" friction="0.5"/>
    </joint>
  </xacro:macro>

  <!-- ============================================ -->
  <!-- Assembly Macros -->
  <!-- ============================================ -->

  <!-- Finger links assembly -->
  <xacro:macro name="finger_links" params="prefix fingerprefix reflect">
    <xacro:outer_knuckle prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}"/>
    <xacro:outer_finger prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}"/>
    <xacro:inner_finger prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}"/>
    <xacro:inner_knuckle prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}"/>
  </xacro:macro>

  <!-- Finger joints assembly -->
  <xacro:macro name="finger_joints" params="prefix fingerprefix reflect mimic_mult knuckle_mimic_mult">
    <xacro:outer_finger_joint prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}"/>
    <xacro:inner_finger_joint prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}" mimic_mult="${mimic_mult}"/>
    <xacro:inner_knuckle_joint prefix="${prefix}" fingerprefix="${fingerprefix}" reflect="${reflect}" knuckle_mimic_mult="${knuckle_mimic_mult}"/>
  </xacro:macro>

</robot>
